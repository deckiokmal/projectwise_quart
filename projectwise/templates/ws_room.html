{% extends 'base.html' %}

{% block title %}Rooms — ProjectWise{% endblock %}

{% block body %}
<div class="app-container">
    <main class="main">
        
        <header class="main__header">
            <h1>War Rooms</h1>
        </header>

        <div style="display:flex; gap:0.5rem; align-items:center;">
            <input type="text" id="room-id" placeholder="Room name or ID" style="flex:1;">
            <input type="text" id="user-id" placeholder="Your name" style="flex:1;">
            <button id="join-room-btn">Join</button>
            <button id="leave-room-btn" disabled>Leave</button>
        </div>

        <section class="main__chat">
            <!-- Pesan akan ter-render di sini -->
        </section>

        <footer class="main__input">
            <form id="chat-form" autocomplete="off">
                <!-- Baris 1: Text input -->
                <div class="input-row">
                    <textarea id="chat-input" name="message" placeholder="Ask anything" autocomplete="off" required
                        rows="1"></textarea>
                </div>


                <!-- Baris 2: Upload + Send -->
                <div class="input-row input-row--actions">
                    <!-- Tombol “+” dengan dropdown (drop-up) -->
                    <div class="upload-dropdown">
                        <button type="button" id="upload-btn" class="btn btn--icon" title="Upload">
                            <i class="fa-solid fa-plus"></i>
                        </button>
                        <!-- Menu drop-up -->
                        <div id="upload-menu" class="upload-menu hidden">
                            <button type="button" data-type="kak" class="upload-menu__item">
                                <i class="fa-regular fa-file-lines"></i> Upload KAK
                            </button>
                            <button type="button" data-type="product" class="upload-menu__item">
                                <i class="fa-solid fa-box"></i> Upload Product
                            </button>
                        </div>
                    </div>

                    <!-- Tombol kirim -->
                    <button type="submit" class="btn btn--send" title="Send Message">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </div>


                <!-- Hidden file input -->
                <input type="file" id="file-input" name="files" class="hidden" multiple />
            </form>
        </footer>
    </main>
</div>
{% endblock %}

{% block scripts %}
<script>
    let ws = null;

    function appendWsMessage(sender, content) {
        const messagesEl = document.getElementById('ws-messages');
        const div = document.createElement('div');
        div.classList.add('msg');
        div.innerHTML = `<strong>${sender}:</strong> ${content}`;
        messagesEl.appendChild(div);
        messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    document.getElementById('join-room-btn').addEventListener('click', () => {
        const roomId = document.getElementById('room-id').value.trim();
        const userId = document.getElementById('user-id').value.trim();
        if (!roomId || !userId) return;
        if (ws) {
            ws.close();
        }
        const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
        ws = new WebSocket(`${protocol}://${window.location.host}/ws/chat/${roomId}/${userId}`);
        ws.onopen = () => {
            appendWsMessage('System', `Connected to room ${roomId} as ${userId}`);
            document.getElementById('ws-input').disabled = false;
            document.getElementById('ws-send-btn').disabled = false;
            document.getElementById('leave-room-btn').disabled = false;
        };
        ws.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                if (data.type === 'completed') {
                    appendWsMessage(data.from, data.content);
                } else {
                    // fallback: treat as plain message
                    appendWsMessage('Assistant', event.data);
                }
            } catch (_) {
                appendWsMessage('Assistant', event.data);
            }
        };
        ws.onclose = () => {
            appendWsMessage('System', 'Disconnected from room');
            document.getElementById('ws-input').disabled = true;
            document.getElementById('ws-send-btn').disabled = true;
            document.getElementById('leave-room-btn').disabled = true;
        };
    });

    document.getElementById('leave-room-btn').addEventListener('click', () => {
        if (ws) {
            ws.close();
            ws = null;
        }
    });

    document.getElementById('ws-send-btn').addEventListener('click', () => {
        const inputEl = document.getElementById('ws-input');
        const text = inputEl.value.trim();
        if (!text || !ws) return;
        ws.send(JSON.stringify({ message: text }));
        appendWsMessage('You', text);
        inputEl.value = '';
    });

    document.getElementById('ws-input').addEventListener('keypress', (event) => {
        if (event.key === 'Enter') {
            event.preventDefault();
            document.getElementById('ws-send-btn').click();
        }
    });
</script>
{% endblock %}